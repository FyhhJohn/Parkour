{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\script\\ui/assets\\script\\ui\\Level.js"],"names":["cc","Class","extends","Component","properties","groupPrefab","Prefab","endNode","Node","scoreLabel","Label","nationSprite","Sprite","nationSpriteFrames","SpriteFrame","finalNode","fireworks","Animation","_isFinal","_levelId","_scrolling","_levelNextEmitted","init","id","GameApp","data","config","level","setFinal","groupIds","JSON","parse","stringify","y","groupInterval","length","index","Math","floor","random","newGroup","splice","node","position","v2","height","spriteFrame","string","levelScore","ui","on","ani","scheduleOnce","play","active","update","delta","mapVelocity","emit","offset","destroy","instantiate","getComponent","parent","getScore","positionY","levelCoefficient","min","score","round"],"mappings":"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","file":"Level.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\script\\ui","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        groupPrefab: cc.Prefab,\r\n        endNode: cc.Node,\r\n        scoreLabel: cc.Label,\r\n        nationSprite: cc.Sprite,\r\n        nationSpriteFrames: [cc.SpriteFrame],\r\n\r\n        finalNode: cc.Node,\r\n        fireworks: [cc.Animation],\r\n        _isFinal: false,\r\n\r\n        _levelId: 0,\r\n        _scrolling: false,\r\n        _levelNextEmitted: false,\r\n    },\r\n\r\n    init(id) {\r\n        this._levelId = id;\r\n        if (!GameApp.data.config.level[id]) {\r\n            this.setFinal();\r\n            return;\r\n        }\r\n        let groupIds = JSON.parse(JSON.stringify(GameApp.data.config.level[id].groupIds));\r\n        // 计算高度\r\n        let y = GameApp.data.groupInterval() / 2;\r\n        // 改为随机顺序\r\n        while (groupIds.length > 0) {\r\n            let index = Math.floor(Math.random() * groupIds.length);\r\n            y += (this.newGroup(groupIds[index], y) + GameApp.data.groupInterval());\r\n            groupIds.splice(index, 1);\r\n        }\r\n        // for (let id of groupIds) {\r\n        //     y += (this.newGroup(id, y) + GameApp.data.groupInterval());\r\n        // }\r\n        y -= (GameApp.data.groupInterval() / 2);\r\n        // 初始化位置\r\n        this.node.position = cc.v2(0, 640);\r\n        this.node.height = y;\r\n        this.endNode.y = (y);\r\n        // 设置国家\r\n        this.nationSprite.spriteFrame = this.nationSpriteFrames[this._levelId - 1];\r\n        this.scoreLabel.string = this._levelId * GameApp.data.levelScore() + 'M';\r\n        // 开始滚动\r\n        this._scrolling = true;\r\n    },\r\n\r\n    setFinal() {\r\n        GameApp.ui.node.on('FIREWORK', () => {\r\n            for (let ani of this.fireworks) {\r\n                this.scheduleOnce(() => {\r\n                    ani.play();\r\n                }, Math.random());\r\n            }\r\n        });\r\n        this._isFinal = true;\r\n        // 设置背景\r\n        this.endNode.active = false;\r\n        this.finalNode.active = true;\r\n        // 设置位置\r\n        this.node.position = cc.v2(0, 640);\r\n        this.node.height = this.finalNode.height;\r\n        // 开始滚动\r\n        this._scrolling = true;\r\n    },\r\n\r\n    update(delta) {\r\n        if (!this._scrolling) {\r\n            return;\r\n        }\r\n        // 滚动背景\r\n        this.node.y = (this.node.y - delta * GameApp.data.mapVelocity());\r\n        // 下一关\r\n        if (!this._levelNextEmitted && 640 - this.node.y > this.node.height) {\r\n            if (this._isFinal) {\r\n                this.node.y = (-640);\r\n                this._scrolling = false;\r\n                GameApp.ui.node.emit('GAME_END');\r\n            }\r\n            else {\r\n                this._levelNextEmitted = true;\r\n                GameApp.ui.node.emit('LEVEL_NEXT');\r\n            }\r\n        }\r\n        // 离开屏幕\r\n        let offset = 200;\r\n        if (this.node.y + this.node.height + offset < -640) {\r\n            this.node.destroy();\r\n        }\r\n    },\r\n\r\n    newGroup(id, y) {\r\n        let node = cc.instantiate(this.groupPrefab);\r\n        let height = node.getComponent('Group').init(id, y);\r\n        node.parent = this.node;\r\n        return height;\r\n    },\r\n\r\n    getScore(positionY) {\r\n        if (this._isFinal) {\r\n            return 0;\r\n        }\r\n        let levelCoefficient = Math.min(1, (positionY - this.node.y) / this.node.height);\r\n        let score = (levelCoefficient + (this._levelId - 1)) * GameApp.data.levelScore();\r\n        return Math.round(score);\r\n    },\r\n});\r\n"]}